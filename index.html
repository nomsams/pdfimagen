<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>PDF Image Extractor • Forensics-Grade</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.min.js" integrity="sha512-L7oEw8h7bVd1VZb7Q2Tg7vJ2B0pW4mSWmP0h7WZK+J+e3u7x7uC8cXv6uY0FjL5pJmWw2Y0W2o0Lw9y2n6F8Pw==" crossorigin="anonymous"></script>
  <script>
    // pdf.js worker (required)
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.6.82/pdf.worker.min.js";
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.21.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet@2.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root {
      --bg-dark:#0f1115; --text-dark:#e7e7ea; --muted-dark:#a5a7ae; --surface-dark:#171a21; --border-dark:#2a2f3a; --primary-dark:#5aa9ff; --accent-dark:#24d8a7; --danger-dark:#ff5d5d;
      --bg-light:#f7f7fb; --text-light:#1d2230; --muted-light:#60657a; --surface-light:#ffffff; --border-light:#dee1ea; --primary-light:#2563eb; --accent-light:#059669; --danger-light:#dc2626;
      --radius:14px; --pad:14px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Ubuntu, Cantarell, "Helvetica Neue", Arial;
    }
    html,body{height:100%}
    body{margin:0;display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:56px 1fr;grid-template-areas:
      "topbar topbar topbar"
      "sidebar main details";
      font-family:var(--font); transition:.2s background,color;}
    body.dark{--bg:var(--bg-dark);--text:var(--text-dark);--muted:var(--muted-dark);--surface:var(--surface-dark);--border:var(--border-dark);--primary:var(--primary-dark);--accent:var(--accent-dark);--danger:var(--danger-dark);}
    body.light{--bg:var(--bg-light);--text:var(--text-light);--muted:var(--muted-light);--surface:var(--surface-light);--border:var(--border-light);--primary:var(--primary-light);--accent:var(--accent-light);--danger:var(--danger-light);}
    body{background:var(--bg);color:var(--text)}
    header{grid-area:topbar;display:flex;align-items:center;gap:12px;padding:0 16px;border-bottom:1px solid var(--border);background:var(--surface);position:sticky;top:0;z-index:5}
    header h1{font-size:16px;margin:0;font-weight:600;letter-spacing:.2px}
    header .spacer{flex:1}
    header button{border:1px solid var(--border);background:transparent;color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
    header button:hover{border-color:var(--primary)}
    #sidebar{grid-area:sidebar;border-right:1px solid var(--border);background:var(--surface);padding:16px;overflow:auto}
    #details{grid-area:details;border-left:1px solid var(--border);background:var(--surface);padding:16px;overflow:auto}
    #main{grid-area:main;display:flex;flex-direction:column;overflow:hidden}
    .box{border:1px dashed var(--border);border-radius:var(--radius);padding:18px;text-align:center;cursor:pointer;background:transparent}
    .box.drag{border-color:var(--primary);background:rgba(90,169,255,.08)}
    .controls{display:grid;gap:12px;margin-top:16px}
    .controls label{font-size:12px;color:var(--muted)}
    .controls select,.controls button{width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
    .muted{color:var(--muted)}
    .progress{margin-top:12px}
    .bar{height:8px;background:linear-gradient(90deg,var(--primary),var(--accent));width:0;border-radius:999px;transition:width .2s}
    .bar-wrap{background:rgba(127,127,127,0.2);border-radius:999px;overflow:hidden}
    .tabs{display:flex;border-bottom:1px solid var(--border);flex:0 0 auto}
    .tabs button{padding:12px 16px;border:none;background:transparent;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
    .tabs button.active{color:var(--text);border-bottom-color:var(--primary)}
    #gallery{padding:16px;overflow:auto}
    #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{height:140px;display:flex;align-items:center;justify-content:center;background:rgba(127,127,127,0.08)}
    .thumb img{max-width:100%;max-height:100%;display:block}
    .meta{padding:8px 10px;font-size:12px;display:grid;gap:4px}
    .meta .row{display:flex;justify-content:space-between;gap:8px}
    .select{padding:8px;border-top:1px solid var(--border);display:flex;gap:8px}
    .select button{flex:1;padding:8px;border:1px solid var(--border);background:transparent;color:var(--text);border-radius:8px;cursor:pointer}
    .select button.sel{background:var(--primary);border-color:var(--primary);color:#fff}
    #preview{position:relative;overflow:auto;flex:1}
    .pageWrap{position:relative;margin:16px auto;width:max-content}
    canvas.pdf{box-shadow:0 12px 32px rgba(0,0,0,.35);border-radius:12px}
    .bbox{position:absolute;border:2px solid var(--primary);background:rgba(90,169,255,.18);cursor:pointer}
    .bbox:hover{background:rgba(90,169,255,.28)}
    .pagination{display:flex;justify-content:center;gap:10px;padding:12px;border-top:1px solid var(--border);flex:0 0 auto}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px}
    code{font-family:var(--mono);font-size:12px}
    .kbd{font-family:var(--mono);font-size:11px;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .danger{color:var(--danger)}
  </style>
</head>
<body class="dark">
  <header>
    <h1>PDF Image Extractor</h1>
    <span class="pill">Status: <span id="status">Idle</span></span>
    <div class="spacer"></div>
    <button id="toggleTheme" title="Toggle theme"><span>Toggle Theme</span></button>
  </header>

  <aside id="sidebar">
    <label for="file" class="box" id="drop">
      <strong>Drag & drop PDF</strong><br/>
      <span class="muted">or click to select</span>
    </label>
    <input id="file" type="file" accept="application/pdf" hidden/>
    <div class="progress" id="progressWrap" style="display:none">
      <div class="bar-wrap"><div class="bar" id="bar"></div></div>
      <div class="muted" id="progressText" style="margin-top:6px">Preparing…</div>
    </div>

    <div class="controls">
      <div>
        <label>Filter by type</label>
        <select id="filter">
          <option value="all">All</option>
          <option value="jpeg">JPEG</option>
          <option value="image">Image</option>
          <option value="inline">Inline</option>
          <option value="canvas">Canvas</option>
        </select>
      </div>
      <div>
        <label>Sort by</label>
        <select id="sort">
          <option value="page">Page</option>
          <option value="size">Pixel Area</option>
          <option value="aspect">Aspect Ratio</option>
          <option value="class">AI Class (A→Z)</option>
        </select>
      </div>
      <button id="exportJson" disabled>Export JSON Manifest</button>
      <button id="downloadZip" disabled>Download Selected as ZIP</button>
      <div class="muted" style="font-size:12px">
        Tip: Click an image → “OCR” for text. Hold <span class="kbd">Shift</span> to multi-select.
      </div>
    </div>
  </aside>

  <main id="main">
    <div class="tabs">
      <button class="active" data-tab="gallery">Asset Gallery</button>
      <button data-tab="preview">Interactive Preview</button>
    </div>
    <section id="gallery">
      <div id="welcome">
        <h2>Welcome</h2>
        <p class="muted">Open a PDF to extract embedded images, with AI classification, precise bounding boxes, and batch export.</p>
      </div>
      <div id="grid"></div>
    </section>

    <section id="preview" style="display:none">
      <div id="pageHost"></div>
      <div class="pagination">
        <button id="prev" disabled>← Prev</button>
        <span id="pageInfo" class="muted"></span>
        <button id="next" disabled>Next →</button>
      </div>
    </section>
  </main>

  <aside id="details">
    <h3>Details</h3>
    <div id="detailsBody" class="muted">Select an asset to see metadata.</div>
  </aside>

<script>
(() => {
  const ui = {
    body: document.body,
    toggleTheme: document.getElementById('toggleTheme'),
    file: document.getElementById('file'),
    drop: document.getElementById('drop'),
    status: document.getElementById('status'),
    bar: document.getElementById('bar'),
    progressWrap: document.getElementById('progressWrap'),
    progressText: document.getElementById('progressText'),
    tabs: document.querySelectorAll('.tabs button'),
    gallerySection: document.getElementById('gallery'),
    previewSection: document.getElementById('preview'),
    grid: document.getElementById('grid'),
    welcome: document.getElementById('welcome'),
    filter: document.getElementById('filter'),
    sort: document.getElementById('sort'),
    exportJson: document.getElementById('exportJson'),
    downloadZip: document.getElementById('downloadZip'),
    details: document.getElementById('detailsBody'),
    prev: document.getElementById('prev'),
    next: document.getElementById('next'),
    pageInfo: document.getElementById('pageInfo'),
    pageHost: document.getElementById('pageHost'),
  };

  const state = {
    pdf: null,
    numPages: 0,
    pages: new Map(), // pageNum -> {width,height,scale}
    assets: [],       // array of asset
    selected: new Set(),
    currentPage: 1,
    model: null,      // mobilenet
  };

  // Theme
  ui.toggleTheme.addEventListener('click', () => {
    ui.body.classList.toggle('dark');
    ui.body.classList.toggle('light');
  });

  // Drag & drop
  ['dragenter','dragover'].forEach(evt =>
    ui.drop.addEventListener(evt, e => { e.preventDefault(); ui.drop.classList.add('drag'); })
  );
  ['dragleave','drop'].forEach(evt =>
    ui.drop.addEventListener(evt, e => { e.preventDefault(); ui.drop.classList.remove('drag'); })
  );
  ui.drop.addEventListener('click', () => ui.file.click());
  ui.drop.addEventListener('drop', e => {
    const f = e.dataTransfer.files?.[0];
    if (f) openPDF(f);
  });
  ui.file.addEventListener('change', e => {
    const f = e.target.files?.[0];
    if (f) openPDF(f);
  });

  // Tabs
  ui.tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.tab)));
  function switchTab(name){
    ui.tabs.forEach(b => b.classList.toggle('active', b.dataset.tab===name));
    ui.gallerySection.style.display = name==='gallery' ? '' : 'none';
    ui.previewSection.style.display = name==='preview' ? '' : 'none';
    if (name==='preview' && state.pdf) renderPreview(state.currentPage);
  }

  // Controls
  ui.filter.addEventListener('change', renderGrid);
  ui.sort.addEventListener('change', renderGrid);
  ui.exportJson.addEventListener('click', exportJSON);
  ui.downloadZip.addEventListener('click', downloadZIP);

  // Page nav
  ui.prev.addEventListener('click', () => renderPreview(state.currentPage-1));
  ui.next.addEventListener('click', () => renderPreview(state.currentPage+1));

  // Helpers
  function setStatus(s){ ui.status.textContent = s; }
  function setProgress(p, t=''){ ui.progressWrap.style.display='block'; ui.bar.style.width = `${p}%`; ui.progressText.textContent = t; }

  async function openPDF(file){
    reset();
    setStatus('Loading PDF…');
    setProgress(5, 'Reading file…');
    const buf = await file.arrayBuffer();
    const loadingTask = pdfjsLib.getDocument({data:new Uint8Array(buf)});
    state.pdf = await loadingTask.promise;
    state.numPages = state.pdf.numPages;
    setProgress(10, `Loaded. Pages: ${state.numPages}`);
    ui.welcome.style.display='none';

    // Extract pages sequentially (stable memory)
    for(let i=1;i<=state.numPages;i++){
      setProgress(10 + Math.round((i-1)/state.numPages*70), `Rendering & intercepting images (page ${i}/${state.numPages})`);
      await extractPage(i);
    }
    setProgress(95, 'Finalizing UI…');

    ui.exportJson.disabled = state.assets.length===0;
    ui.downloadZip.disabled = state.assets.length===0;
    setStatus(`Done: ${state.assets.length} image(s)`);
    setProgress(100, 'Complete');
    renderGrid();
    switchTab('gallery');
  }

  function reset(){
    state.assets = [];
    state.selected.clear();
    state.pages.clear();
    state.currentPage = 1;
    ui.grid.innerHTML='';
    ui.details.innerHTML='Select an asset to see metadata.';
    ui.pageHost.innerHTML='';
    ui.pageInfo.textContent='';
    ui.prev.disabled = true;
    ui.next.disabled = true;
    setStatus('Idle');
    setProgress(0,'');
  }

  // Intercept drawImage on a temporary context for each page render
  async function extractPage(pageNum){
    const page = await state.pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 2.0 }); // high-res for cleaner crops
    const canvas = document.createElement('canvas');
    canvas.width = viewport.width|0;
    canvas.height = viewport.height|0;
    const ctx = canvas.getContext('2d');

    // Record page dims
    state.pages.set(pageNum, { width: canvas.width, height: canvas.height, scale: 2.0 });

    const origDrawImage = CanvasRenderingContext2D.prototype.drawImage;

    // A tiny ID sequencer per page
    let seq = 0;

    CanvasRenderingContext2D.prototype.drawImage = function(...args){
      try{
        // Capture before actual draw to ensure we get the right source
        const img = args[0];
        if (!img) return origDrawImage.apply(this,args);

        // Forms:
        // drawImage(image, dx, dy)
        // drawImage(image, dx, dy, dWidth, dHeight)
        // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
        let sx=0, sy=0, sWidth, sHeight, dx=0, dy=0, dWidth, dHeight, usedForm=0;
        if (args.length===3){ usedForm=3; dx=args[1]; dy=args[2]; dWidth=img.width; dHeight=img.height; sWidth=img.width; sHeight=img.height; }
        else if (args.length===5){ usedForm=5; dx=args[1]; dy=args[2]; dWidth=args[3]; dHeight=args[4]; sWidth=img.width; sHeight=img.height; }
        else if (args.length===9){ usedForm=9; sx=args[1]; sy=args[2]; sWidth=args[3]; sHeight=args[4]; dx=args[5]; dy=args[6]; dWidth=args[7]; dHeight=args[8]; }
        else { return origDrawImage.apply(this,args); }

        // Crop source to an offscreen canvas
        const cropW = Math.max(1, Math.floor(sWidth));
        const cropH = Math.max(1, Math.floor(sHeight));
        const off = new OffscreenCanvas(cropW, cropH);
        const octx = off.getContext('2d');
        // Draw full source into temp then extract region if needed
        try{
          // Some sources are already Canvas/ImageBitmap; draw and then copy region
          octx.drawImage(img, 0, 0);
          if (usedForm===9){
            // Re-crop into another canvas to avoid sampling issues
            const off2 = new OffscreenCanvas(sWidth, sHeight);
            const o2 = off2.getContext('2d');
            o2.drawImage(off, sx, sy, sWidth, sHeight, 0, 0, sWidth, sHeight);
            postAsset(off2, pageNum, guessType(img), { x: dx, y: dy, w: dWidth, h: dHeight }, seq++);
          } else {
            postAsset(off, pageNum, guessType(img), { x: dx, y: dy, w: dWidth, h: dHeight }, seq++);
          }
        } catch(e){
          // Fallback: use a canvas of destination size and draw
          const offF = new OffscreenCanvas(Math.max(1, Math.floor(dWidth)), Math.max(1, Math.floor(dHeight)));
          const oF = offF.getContext('2d');
          if (usedForm===9) oF.drawImage(img, sx, sy, sWidth, sHeight, 0, 0, dWidth, dHeight);
          else oF.drawImage(img, 0, 0, dWidth, dHeight);
          postAsset(offF, pageNum, 'canvas', { x: dx, y: dy, w: dWidth, h: dHeight }, seq++);
        }
      } catch(e){
        console.warn('drawImage intercept failed:', e);
      }
      return origDrawImage.apply(this,args);
    };

    // Render page (this triggers our intercepts)
    await page.render({ canvasContext: ctx, viewport }).promise;

    // Restore original
    CanvasRenderingContext2D.prototype.drawImage = origDrawImage;

    // Keep a preview canvas for this page (for preview tab)
    page.cleanup?.();
    const pageURL = canvas.toDataURL('image/webp', 0.85);
    state.pages.get(pageNum).previewURL = pageURL;
  }

  function guessType(img){
    // Heuristic type label (for filtering only)
    const name = Object.prototype.toString.call(img);
    if (name.includes('ImageBitmap')) return 'image';
    if (name.includes('HTMLCanvas')) return 'canvas';
    if (name.includes('ImageData')) return 'inline';
    return 'image';
  }

  async function postAsset(offscreenCanvas, page, type, bbox, seq){
    try{
      const blob = await offscreenCanvas.convertToBlob({ type: 'image/png', quality: 0.92 });
      const url = URL.createObjectURL(blob);
      const w = offscreenCanvas.width;
      const h = offscreenCanvas.height;
      const area = w*h;
      const ar = +(w/h).toFixed(3);
      const id = `p${page}-${String(seq).padStart(3,'0')}`;
      const asset = {
        id, page, type, width:w, height:h, area, aspect:ar,
        bbox: { x: bbox.x, y: bbox.y, w: bbox.w, h: bbox.h },
        url, blob, aiClass: '—', ocr: null
      };
      state.assets.push(asset);
      // Non-blocking AI classification
      classify(asset).catch(()=>{});
    } catch(e){
      console.warn('postAsset failed', e);
    }
  }

  async function classify(asset){
    try{
      if (!state.model){
        setStatus('Loading AI model…');
        state.model = await mobilenet.load();
        setStatus('Ready');
      }
      // Create bitmap for classification
      const bmp = await createImageBitmap(asset.blob);
      const can = new OffscreenCanvas(bmp.width, bmp.height);
      const ctx = can.getContext('2d');
      ctx.drawImage(bmp, 0, 0);
      const preds = await state.model.classify(can);
      asset.aiClass = preds?.[0]?.className?.split(',')[0] ?? 'unknown';
      // If visible in grid, update label
      const tag = document.querySelector(`[data-asset="${asset.id}"] .ai`);
      if (tag) tag.textContent = asset.aiClass;
    } catch(e){
      asset.aiClass = 'error';
    }
  }

  function renderGrid(){
    const f = ui.filter.value;
    const s = ui.sort.value;
    let list = [...state.assets];
    if (f!=='all') list = list.filter(a => a.type===f || (f==='jpeg' && a.blob.type.includes('jpeg')));
    if (s==='page') list.sort((a,b)=>a.page-b.page || a.id.localeCompare(b.id));
    if (s==='size') list.sort((a,b)=>b.area-a.area);
    if (s==='aspect') list.sort((a,b)=>b.aspect-a.aspect);
    if (s==='class') list.sort((a,b)=>String(a.aiClass).localeCompare(String(b.aiClass)));

    ui.grid.innerHTML='';
    for(const a of list){
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.asset = a.id;

      const thumb = document.createElement('div');
      thumb.className = 'thumb';
      const img = document.createElement('img');
      img.loading='lazy';
      img.src = a.url;
      thumb.appendChild(img);

      const meta = document.createElement('div');
      meta.className='meta';
      meta.innerHTML = `
        <div class="row"><span><strong>${a.id}</strong></span><span class="muted">p.${a.page}</span></div>
        <div class="row"><span>${a.width}×${a.height}</span><span>${(a.area/1e6).toFixed(2)} MP</span></div>
        <div class="row"><span>Aspect</span><span>${a.aspect}</span></div>
        <div class="row"><span>Type</span><span>${a.type}</span></div>
        <div class="row"><span>AI</span><span class="ai">${a.aiClass}</span></div>
      `;

      const sel = document.createElement('div');
      sel.className='select';
      const btnSel = document.createElement('button');
      btnSel.textContent = state.selected.has(a.id) ? 'Selected' : 'Select';
      btnSel.classList.toggle('sel', state.selected.has(a.id));
      btnSel.addEventListener('click', (ev) => {
        ev.stopPropagation();
        toggleSelect(a.id, ev.shiftKey);
        btnSel.textContent = state.selected.has(a.id) ? 'Selected' : 'Select';
        btnSel.classList.toggle('sel', state.selected.has(a.id));
      });

      const btnOcr = document.createElement('button');
      btnOcr.textContent = 'OCR';
      btnOcr.addEventListener('click', async (ev) => {
        ev.stopPropagation();
        btnOcr.disabled = true;
        btnOcr.textContent = 'OCR…';
        try{
          const { data } = await Tesseract.recognize(a.blob, 'eng');
          a.ocr = data.text.trim();
          showDetails(a);
        } finally{
          btnOcr.disabled = false;
          btnOcr.textContent = 'OCR';
        }
      });

      sel.append(btnSel, btnOcr);
      card.append(thumb, meta, sel);
      card.addEventListener('click', ()=> {
        showDetails(a);
        // Jump to preview page & highlight bbox
        switchTab('preview');
        renderPreview(a.page, a.id);
      });
      ui.grid.appendChild(card);
    }
  }

  function toggleSelect(id, multi=false){
    if (!multi) state.selected.clear();
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
    ui.downloadZip.disabled = state.selected.size===0;
  }

  function showDetails(a){
    const bb = a.bbox;
    ui.details.innerHTML = `
      <div><strong>ID:</strong> ${a.id}</div>
      <div><strong>Page:</strong> ${a.page}</div>
      <div><strong>Pixels:</strong> ${a.width} × ${a.height} (${(a.area/1e6).toFixed(2)} MP)</div>
      <div><strong>Aspect:</strong> ${a.aspect}</div>
      <div><strong>Type:</strong> ${a.type}</div>
      <div><strong>AI class:</strong> ${a.aiClass}</div>
      <div><strong>BBox (page px):</strong> x=${bb.x.toFixed(1)}, y=${bb.y.toFixed(1)}, w=${bb.w.toFixed(1)}, h=${bb.h.toFixed(1)}</div>
      <div style="margin-top:8px"><strong>OCR:</strong><br><pre style="white-space:pre-wrap;font-family:var(--mono);border:1px solid var(--border);padding:8px;border-radius:8px;max-height:180px;overflow:auto">${a.ocr ?? '—'}</pre></div>
      <div style="margin-top:8px"><a href="${a.url}" download="${a.id}.png">Download PNG</a></div>
    `;
  }

  async function renderPreview(pageNum, highlightId=null){
    if (!state.pdf) return;
    pageNum = Math.max(1, Math.min(state.numPages, pageNum));
    state.currentPage = pageNum;
    ui.pageHost.innerHTML = '';

    const pageInfo = state.pages.get(pageNum);
    if (!pageInfo?.previewURL){
      // If not rendered yet (should not happen), force render minimal view
      const page = await state.pdf.getPage(pageNum);
      const viewport = page.getViewport({scale:1.2});
      const c = document.createElement('canvas');
      c.className='pdf';
      c.width = viewport.width|0; c.height = viewport.height|0;
      await page.render({canvasContext:c.getContext('2d'), viewport}).promise;
      pageInfo.width = c.width; pageInfo.height=c.height; pageInfo.scale=1.2;
      pageInfo.previewURL = c.toDataURL('image/webp', 0.85);
    }
    const wrap = document.createElement('div');
    wrap.className='pageWrap';
    const img = document.createElement('img');
    img.src = pageInfo.previewURL;
    img.className='pdf';
    img.style.display='block';
    wrap.appendChild(img);

    // Add bboxes for assets on this page
    const assetsOnPage = state.assets.filter(a => a.page===pageNum);
    for(const a of assetsOnPage){
      const bb = a.bbox;
      const box = document.createElement('div');
      box.className='bbox';
      box.style.left = `${bb.x}px`;
      box.style.top = `${bb.y}px`;
      box.style.width = `${bb.w}px`;
      box.style.height = `${bb.h}px`;
      if (a.id===highlightId){
        box.style.boxShadow = '0 0 0 3px rgba(36,216,167,.9) inset';
      }
      box.title = `${a.id} (${a.width}×${a.height})`;
      box.addEventListener('click', () => {
        showDetails(a);
        highlightInGallery(a.id);
      });
      wrap.appendChild(box);
    }

    ui.pageHost.appendChild(wrap);
    ui.pageInfo.textContent = `Page ${pageNum} / ${state.numPages}`;
    ui.prev.disabled = pageNum<=1;
    ui.next.disabled = pageNum>=state.numPages;
  }

  function highlightInGallery(id){
    const el = document.querySelector(`[data-asset="${id}"]`);
    if (!el) return;
    el.scrollIntoView({behavior:'smooth', block:'center'});
    el.style.outline = `2px solid var(--accent)`;
    setTimeout(()=> el.style.outline='none', 1200);
  }

  function exportJSON(){
    const manifest = state.assets.map(a => ({
      id: a.id,
      page: a.page,
      type: a.type,
      width: a.width,
      height: a.height,
      aspect: a.aspect,
      bbox: a.bbox,
      aiClass: a.aiClass,
      ocr: a.ocr ?? null,
      filename: `${a.id}.png`
    }));
    const blob = new Blob([JSON.stringify({ pages: state.numPages, assets: manifest }, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    downloadURL(url, 'pdf-image-manifest.json');
  }

  async function downloadZIP(){
    const zip = new JSZip();
    const chosen = state.selected.size ? state.assets.filter(a=>state.selected.has(a.id)) : state.assets;
    const manifest = [];
    for(const a of chosen){
      const ab = await a.blob.arrayBuffer();
      zip.file(`${a.id}.png`, ab);
      manifest.push({
        id:a.id,page:a.page,type:a.type,width:a.width,height:a.height,aspect:a.aspect,bbox:a.bbox,aiClass:a.aiClass,ocr:a.ocr??null,filename:`${a.id}.png`
      });
    }
    zip.file('manifest.json', JSON.stringify({pages: state.numPages, assets: manifest}, null, 2));
    const out = await zip.generateAsync({type:'blob'});
    const url = URL.createObjectURL(out);
    downloadURL(url, `pdf-images-${Date.now()}.zip`);
  }

  function downloadURL(url, filename){
    const a = document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }

  // Start in dark
  ui.body.classList.add('dark');

})();
</script>
</body>
</html>
