<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PDF Image Extractor • Stable (2.16.105)</title>

<!-- pdf.js (stable 2.16.105) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  // Make sure pdf.js is present before setting workerSrc.
  (function ensurePdfjsReady(){
    const lib = window.pdfjsLib;
    if (!lib) { return setTimeout(ensurePdfjsReady, 30); }
    lib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    // Optional stable alias
    window.PDFJS = lib;
  })();
</script>

<!-- Optional OCR & ZIP (you can remove if not needed) -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
  :root{
    --bg:#0f1115;--tx:#e7e7ea;--bd:#2a2f3a;--sf:#171a21;--pri:#5aa9ff;--ok:#24d8a7;--err:#ff6161;
    --r:12px;--mono:ui-monospace,Menlo,Consolas,monospace;--sans:ui-sans-serif,system-ui,Segoe UI,Roboto,Arial;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--tx);font-family:var(--sans);display:grid;grid-template-columns:300px 1fr 340px;grid-template-rows:56px 1fr;grid-template-areas:"top top top" "left main right";height:100vh}
  header{grid-area:top;display:flex;gap:12px;align-items:center;border-bottom:1px solid var(--bd);padding:0 16px;background:var(--sf)}
  header h1{font-size:16px;margin:0}
  #left{grid-area:left;border-right:1px solid var(--bd);padding:14px;overflow:auto;background:var(--sf)}
  #right{grid-area:right;border-left:1px solid var(--bd);padding:14px;overflow:auto;background:var(--sf)}
  #main{grid-area:main;display:flex;flex-direction:column;min-width:0}
  .drop{border:1px dashed var(--bd);border-radius:12px;padding:18px;text-align:center;cursor:pointer}
  .drop.drag{border-color:var(--pri);background:rgba(90,169,255,.08)}
  .muted{opacity:.7}
  .barwrap{height:8px;background:#1d2230;border-radius:999px;overflow:hidden;margin-top:8px}
  .bar{height:8px;width:0;background:linear-gradient(90deg,var(--pri),var(--ok));transition:width .2s}
  .err{border:1px solid var(--err);color:#fff;background:rgba(255,97,97,.1);padding:10px;border-radius:10px;margin-top:10px;white-space:pre-wrap}
  .tabs{display:flex;border-bottom:1px solid var(--bd)}
  .tabs button{background:transparent;border:none;color:#bfc3cf;padding:10px 14px;border-bottom:2px solid transparent;cursor:pointer}
  .tabs button.active{color:#fff;border-bottom-color:var(--pri)}
  #gallery{padding:14px;overflow:auto}
  #grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px}
  .card{border:1px solid var(--bd);border-radius:10px;overflow:hidden}
  .thumb{height:140px;display:flex;align-items:center;justify-content:center;background:#12151c}
  .thumb img{max-width:100%;max-height:100%}
  .meta{padding:8px 10px;font-size:12px;display:grid;gap:4px}
  .row{display:flex;justify-content:space-between;gap:10px}
  .sel{display:flex;gap:8px;border-top:1px solid var(--bd);padding:8px}
  .sel button{flex:1;border:1px solid var(--bd);background:transparent;color:#fff;border-radius:8px;padding:6px;cursor:pointer}
  .sel button.active{background:var(--pri);border-color:var(--pri)}
  #preview{flex:1;overflow:auto;padding:12px}
  .pageWrap{position:relative;margin:0 auto 16px;width:max-content}
  canvas.pdf{box-shadow:0 10px 30px rgba(0,0,0,.35);border-radius:12px}
  .bbox{position:absolute;border:2px solid var(--pri);background:rgba(90,169,255,.22);cursor:pointer}
  .controls{display:grid;gap:10px;margin-top:12px}
  select,button{border:1px solid var(--bd);background:transparent;color:#fff;border-radius:8px;padding:8px;cursor:pointer}
</style>
</head>
<body>
<header>
  <h1>PDF Image Extractor</h1>
  <div class="muted" id="status">Idle</div>
</header>

<aside id="left">
  <label class="drop" id="drop"><strong>Drag & drop PDF</strong><br><span class="muted">or click to select</span></label>
  <input id="file" type="file" accept="application/pdf" hidden>
  <div style="margin-top:10px">
    <div class="barwrap"><div class="bar" id="bar"></div></div>
    <div id="ptext" class="muted">Waiting…</div>
    <div id="err" class="err" style="display:none"></div>
  </div>

  <div class="controls">
    <div>
      <label class="muted">Filter</label>
      <select id="filter">
        <option value="all">All</option>
        <option value="image">Image</option>
        <option value="canvas">Canvas</option>
      </select>
    </div>
    <div>
      <label class="muted">Sort</label>
      <select id="sort">
        <option value="page">Page</option>
        <option value="size">Pixel Area</option>
        <option value="aspect">Aspect</option>
      </select>
    </div>
    <button id="exportJson" disabled>Export JSON</button>
    <button id="downloadZip" disabled>Download ZIP (selected/all)</button>
  </div>
</aside>

<main id="main">
  <div class="tabs">
    <button class="active" data-tab="gallery">Asset Gallery</button>
    <button data-tab="preview">Interactive Preview</button>
  </div>
  <section id="gallery">
    <div id="welcome">
      <h3>Welcome</h3>
      <p class="muted">Open a PDF to extract images. This version pins pdf.js 2.16.105 and handles Safari/Chromium quirks.</p>
    </div>
    <div id="grid"></div>
  </section>
  <section id="preview" style="display:none">
    <div id="pages"></div>
  </section>
</main>

<aside id="right">
  <h3>Details</h3>
  <div id="details" class="muted">Select an asset…</div>
</aside>

<script>
(() => {
  // ----------- Helpers for pdf.js availability -----------
  function getPDF() {
    const PDF = window.PDFJS || window.pdfjsLib;
    if (!PDF) throw new Error("pdf.js failed to load. Check network and script tag.");
    return PDF;
  }

  // ----------- Polyfills & feature detection -----------
  const hasOffscreen = typeof OffscreenCanvas !== 'undefined';
  function canvasToBlob(canvas, type='image/png', quality=0.92){
    if (hasOffscreen && canvas instanceof OffscreenCanvas){
      return canvas.convertToBlob({type, quality});
    }
    return new Promise(res => canvas.toBlob(res, type, quality));
  }
  async function bitmapFromBlob(blob){
    if ('createImageBitmap' in window) return await createImageBitmap(blob);
    // Safari fallback
    return await new Promise((resolve, reject)=>{
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        c.width = img.naturalWidth; c.height = img.naturalHeight;
        c.getContext('2d').drawImage(img,0,0);
        resolve(c);
      };
      img.onerror = reject;
      img.src = URL.createObjectURL(blob);
    });
  }
  function showErr(e){
    const el = document.getElementById('err');
    el.style.display='block';
    el.textContent = (e && e.message) ? e.message : String(e);
    console.error(e);
  }
  function clearErr(){ const el = document.getElementById('err'); el.style.display='none'; el.textContent=''; }

  // ----------- UI refs -----------
  const ui = {
    drop: document.getElementById('drop'),
    file: document.getElementById('file'),
    bar: document.getElementById('bar'),
    ptext: document.getElementById('ptext'),
    status: document.getElementById('status'),
    tabs: document.querySelectorAll('.tabs button'),
    gallery: document.getElementById('gallery'),
    preview: document.getElementById('preview'),
    grid: document.getElementById('grid'),
    pages: document.getElementById('pages'),
    exportJson: document.getElementById('exportJson'),
    downloadZip: document.getElementById('downloadZip'),
    filter: document.getElementById('filter'),
    sort: document.getElementById('sort'),
    details: document.getElementById('details'),
    welcome: document.getElementById('welcome'),
  };

  // ----------- State -----------
  let abortLoad = null;
  const state = {
    pdf:null, numPages:0, assets:[], selected:new Set(), pages:new Map()
  };

  // ----------- Misc helpers -----------
  function progress(p, t){ ui.bar.style.width=p+'%'; ui.ptext.textContent=t||''; }
  function setStatus(t){ ui.status.textContent = t; }

  // DnD
  ['dragenter','dragover'].forEach(evt => ui.drop.addEventListener(evt, e=>{e.preventDefault(); ui.drop.classList.add('drag');}));
  ['dragleave','drop'].forEach(evt => ui.drop.addEventListener(evt, e=>{e.preventDefault(); ui.drop.classList.remove('drag');}));
  ui.drop.addEventListener('click',()=>ui.file.click());
  ui.drop.addEventListener('drop',e=> { const f=e.dataTransfer.files?.[0]; if(f) openPDF(f); });
  ui.file.addEventListener('change',e=>{ const f=e.target.files?.[0]; if(f) openPDF(f); });

  // Tabs
  ui.tabs.forEach(b => b.addEventListener('click',()=>switchTab(b.dataset.tab)));
  function switchTab(name){
    ui.tabs.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    ui.gallery.style.display = name==='gallery'? '' : 'none';
    ui.preview.style.display = name==='preview'? '' : 'none';
    if (name==='preview' && state.pdf) renderPreview();
  }

  // Controls
  ui.filter.addEventListener('change', renderGrid);
  ui.sort.addEventListener('change', renderGrid);
  ui.exportJson.addEventListener('click', exportJSON);
  ui.downloadZip.addEventListener('click', downloadZIP);

  function reset(){
    if (abortLoad){ abortLoad.abort(); abortLoad = null; }
    clearErr();
    state.pdf=null; state.numPages=0; state.assets=[]; state.selected.clear(); state.pages.clear();
    ui.grid.innerHTML=''; ui.pages.innerHTML=''; ui.details.textContent='Select an asset…';
    ui.exportJson.disabled = true; ui.downloadZip.disabled = true;
    ui.welcome.style.display=''; progress(0,'Waiting…'); setStatus('Idle');
  }

  async function openPDF(file){
    try{
      reset();
      abortLoad = new AbortController();
      const { signal } = abortLoad;

      setStatus('Reading file…'); progress(5,'Reading file…');
      const buf = await file.arrayBuffer();
      if (signal.aborted) return;

      progress(10,'Loading pdf.js document…');
      const PDF = getPDF();
      const task = PDF.getDocument({data:new Uint8Array(buf)});
      state.pdf = await task.promise;
      state.numPages = state.pdf.numPages;
      setStatus(`Loaded (${state.numPages} pages)`); progress(15,'Starting extraction…');
      ui.welcome.style.display='none';

      for (let i=1;i<=state.numPages;i++){
        if (signal.aborted) return;
        progress(15 + Math.round((i-1)/state.numPages*70), `Page ${i}/${state.numPages}`);
        await extractPage(i);
      }

      progress(95,'Finalizing…'); renderGrid(); setStatus(`Done: ${state.assets.length} images`);
      ui.exportJson.disabled = state.assets.length===0;
      ui.downloadZip.disabled = state.assets.length===0;
      progress(100,'Complete');
    } catch(e){
      showErr(e);
      setStatus('Error');
    }
  }

  // Safe drawImage interception (2.16 works with CanvasRenderingContext2D)
  async function extractPage(pageNum){
    const PDF = getPDF();
    const page = await state.pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 2.0 });
    const canvas = document.createElement('canvas');
    canvas.width = Math.max(1, viewport.width|0);
    canvas.height = Math.max(1, viewport.height|0);
    const ctx = canvas.getContext('2d');

    state.pages.set(pageNum, { w: canvas.width, h: canvas.height });

    const orig = CanvasRenderingContext2D.prototype.drawImage;
    let seq = 0;
    CanvasRenderingContext2D.prototype.drawImage = function(...args){
      try{
        const img = args[0];
        if (!img) return orig.apply(this,args);
        let sx=0,sy=0,sW=img.width,sH=img.height,dx=0,dy=0,dW=sW,dH=sH;
        if (args.length===3){ dx=args[1]; dy=args[2]; }
        else if (args.length===5){ dx=args[1]; dy=args[2]; dW=args[3]; dH=args[4]; }
        else if (args.length===9){ sx=args[1]; sy=args[2]; sW=args[3]; sH=args[4]; dx=args[5]; dy=args[6]; dW=args[7]; dH=args[8]; }

        let off;
        if (hasOffscreen) off = new OffscreenCanvas(Math.max(1,sW), Math.max(1,sH));
        else { off = document.createElement('canvas'); off.width=Math.max(1,sW); off.height=Math.max(1,sH); }
        const octx = off.getContext('2d');

        try{
          if (args.length===9) octx.drawImage(img, sx, sy, sW, sH, 0, 0, sW, sH);
          else octx.drawImage(img, 0, 0);
          postAsset(off, pageNum, guessType(img), {x:dx, y:dy, w:dW, h:dH}, seq++);
        }catch(_){}
      }catch(_){}
      return orig.apply(this,args);
    };

    try{
      await page.render({ canvasContext: ctx, viewport }).promise;
    } finally {
      CanvasRenderingContext2D.prototype.drawImage = orig;
    }

    // Keep preview image for overlay
    const url = canvas.toDataURL('image/webp', 0.85);
    state.pages.get(pageNum).preview = url;
    page.cleanup?.();
  }

  function guessType(img){
    const t = Object.prototype.toString.call(img);
    if (t.includes('ImageBitmap')) return 'image';
    if (t.includes('HTMLCanvas')) return 'canvas';
    return 'image';
  }

  async function postAsset(off, page, type, bbox, seq){
    try{
      const blob = await canvasToBlob(off, 'image/png', 0.92);
      const url = URL.createObjectURL(blob);
      const w = off.width, h = off.height;
      const id = `p${page}-${String(seq).padStart(3,'0')}`;
      state.assets.push({ id, page, type, width:w, height:h, area:w*h, aspect:+(w/h).toFixed(3), bbox, url, blob, ocr:null });
    } catch(e){
      console.warn('postAsset failed', e);
    }
  }

  // ----------- Rendering -----------
  function renderGrid(){
    const f = ui.filter.value, s = ui.sort.value;
    let items = [...state.assets];
    if (f!=='all') items = items.filter(a=>a.type===f);
    if (s==='page') items.sort((a,b)=>a.page-b.page || a.id.localeCompare(b.id));
    if (s==='size') items.sort((a,b)=>b.area-a.area);
    if (s==='aspect') items.sort((a,b)=>b.aspect-a.aspect);

    ui.grid.innerHTML='';
    items.forEach(a=>{
      const card = document.createElement('div'); card.className='card'; card.dataset.id=a.id;
      const th = document.createElement('div'); th.className='thumb';
      const img = document.createElement('img'); img.src=a.url; img.loading='lazy'; th.appendChild(img);
      const meta = document.createElement('div'); meta.className='meta';
      meta.innerHTML = `
        <div class="row"><strong>${a.id}</strong><span class="muted">p.${a.page}</span></div>
        <div class="row"><span>${a.width}×${a.height}</span><span>${(a.area/1e6).toFixed(2)} MP</span></div>
        <div class="row"><span>Aspect</span><span>${a.aspect}</span></div>
        <div class="row"><span>Type</span><span>${a.type}</span></div>`;
      const sel = document.createElement('div'); sel.className='sel';
      const bSel = document.createElement('button'); bSel.textContent='Select'; bSel.classList.toggle('active', state.selected.has(a.id));
      bSel.onclick = e => { e.stopPropagation(); toggleSelect(a.id); bSel.classList.toggle('active', state.selected.has(a.id)); };
      const bOcr = document.createElement('button'); bOcr.textContent='OCR'; bOcr.onclick = async (e)=>{ e.stopPropagation(); await runOCR(a); };
      sel.append(bSel,bOcr);

      card.append(th,meta,sel);
      card.onclick = () => { showDetails(a); switchTab('preview'); renderPreview(a.page, a.id); };
      ui.grid.appendChild(card);
    });
    ui.exportJson.disabled = state.assets.length===0;
    ui.downloadZip.disabled = (state.assets.length===0);
  }

  async function runOCR(a){
    try{
      setStatus('OCR…');
      const { data } = await Tesseract.recognize(a.blob,'eng');
      a.ocr = (data.text||'').trim();
      showDetails(a);
      setStatus('Done');
    } catch(e){
      showErr(e);
    }
  }

  function showDetails(a){
    const bb = a.bbox;
    ui.details.innerHTML = `
      <div><strong>ID:</strong> ${a.id}</div>
      <div><strong>Page:</strong> ${a.page}</div>
      <div><strong>Size:</strong> ${a.width}×${a.height} (${(a.area/1e6).toFixed(2)} MP)</div>
      <div><strong>Aspect:</strong> ${a.aspect}</div>
      <div><strong>Type:</strong> ${a.type}</div>
      <div><strong>BBox:</strong> x=${bb.x.toFixed(1)}, y=${bb.y.toFixed(1)}, w=${bb.w.toFixed(1)}, h=${bb.h.toFixed(1)}</div>
      <div style="margin-top:8px"><a href="${a.url}" download="${a.id}.png">Download PNG</a></div>
      <div style="margin-top:8px"><strong>OCR</strong><pre style="white-space:pre-wrap;font-family:var(--mono);border:1px solid var(--bd);padding:8px;border-radius:8px;max-height:180px;overflow:auto">${a.ocr ?? '—'}</pre></div>
    `;
  }

  async function renderPreview(highlightPage=null, highlightId=null){
    ui.pages.innerHTML='';
    const toShow = highlightPage ? [highlightPage] : [...state.pages.keys()];
    for (const p of toShow){
      const info = state.pages.get(p);
      if (!info?.preview){
        const PDF = getPDF();
        const page = await state.pdf.getPage(p);
        const vp = page.getViewport({scale:1.2});
        const c = document.createElement('canvas'); c.width=vp.width|0; c.height=vp.height|0; await page.render({canvasContext:c.getContext('2d'),viewport:vp}).promise;
        info.preview = c.toDataURL('image/webp',0.85);
      }
      const wrap = document.createElement('div'); wrap.className='pageWrap';
      const cv = document.createElement('canvas'); cv.className='pdf'; cv.width=info.w; cv.height=info.h; wrap.appendChild(cv);
      const ctx = cv.getContext('2d');
      const img = new Image(); img.src = info.preview; await img.decode(); ctx.drawImage(img,0,0);

      state.assets.filter(a=>a.page===p).forEach(a=>{
        const bb = a.bbox;
        const box = document.createElement('div'); box.className='bbox';
        box.style.left = bb.x+'px'; box.style.top = bb.y+'px';
        box.style.width = bb.w+'px'; box.style.height = bb.h+'px';
        if (a.id===highlightId) box.style.boxShadow='0 0 0 3px rgba(36,216,167,.9) inset';
        box.title = `${a.id}`;
        box.onclick = ()=>{ showDetails(a); };
        wrap.appendChild(box);
      });
      ui.pages.appendChild(wrap);
    }
  }

  function toggleSelect(id){
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
  }

  function exportJSON(){
    const manifest = state.assets.map(a=>({
      id:a.id,page:a.page,type:a.type,width:a.width,height:a.height,aspect:a.aspect,bbox:a.bbox,ocr:a.ocr??null,filename:`${a.id}.png`
    }));
    const blob = new Blob([JSON.stringify({pages:state.numPages, assets:manifest}, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    download(url, 'pdf-image-manifest.json');
  }

  async function downloadZIP(){
    const zip = new JSZip();
    const chosen = state.selected.size ? state.assets.filter(a=>state.selected.has(a.id)) : state.assets;
    const manifest = [];
    for (const a of chosen){
      zip.file(`${a.id}.png`, await a.blob.arrayBuffer());
      manifest.push({id:a.id,page:a.page,type:a.type,width:a.width,height:a.height,aspect:a.aspect,bbox:a.bbox,ocr:a.ocr??null,filename:`${a.id}.png`});
    }
    zip.file('manifest.json', JSON.stringify({pages:state.numPages, assets:manifest}, null, 2));
    const out = await zip.generateAsync({type:'blob'});
    download(URL.createObjectURL(out), `pdf-images-${Date.now()}.zip`);
  }

  function download(url, name){
    const a = document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
  }

})();
</script>
</body>
</html>
