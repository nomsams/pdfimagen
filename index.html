<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>PDF Image Extractor • Ultimate</title>

<!-- PDF.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script>
  (function ensurePdfjsReady(){
    const lib = window.pdfjsLib;
    if (!lib) { return setTimeout(ensurePdfjsReady, 30); }
    lib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  })();
</script>

<!-- Utilities -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.0/dist/tesseract.min.js"></script>

<style>
  :root {
    --bg: #121212; --surf: #1e1e1e; --surf-2: #2c2c2c;
    --txt: #e0e0e0; --txt-dim: #a0a0a0;
    --acc: #4caf50; --acc-hov: #43a047;
    --sel: #2196f3; --err: #f44336;
    --border: #333;
    --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  }
  * { box-sizing: border-box; outline: none; }
  body {
    margin: 0; background: var(--bg); color: var(--txt); font-family: var(--font);
    display: grid; height: 100vh; overflow: hidden;
    grid-template-columns: 300px 1fr 320px;
    grid-template-rows: 50px 1fr;
    grid-template-areas: "head head head" "left main right";
  }

  /* Header */
  header {
    grid-area: head; background: var(--surf); border-bottom: 1px solid var(--border);
    display: flex; align-items: center; padding: 0 20px; justify-content: space-between;
  }
  h1 { font-size: 16px; margin: 0; font-weight: 600; letter-spacing: 0.5px; }
  #status { font-size: 13px; color: var(--txt-dim); font-family: monospace; }

  /* Layout */
  aside { background: var(--surf); overflow-y: auto; display: flex; flex-direction: column; }
  #left { grid-area: left; border-right: 1px solid var(--border); padding: 15px; gap: 15px; }
  #right { grid-area: right; border-left: 1px solid var(--border); }
  #main { grid-area: main; background: var(--bg); display: flex; flex-direction: column; position: relative; }

  /* Drop Zone */
  .drop-zone {
    border: 2px dashed var(--border); border-radius: 8px; padding: 20px;
    text-align: center; cursor: pointer; transition: 0.2s; background: var(--surf-2);
  }
  .drop-zone:hover { border-color: var(--acc); background: rgba(76,175,80,0.1); }
  .drop-zone.drag { border-color: var(--sel); background: rgba(33,150,243,0.1); }
  .drop-zone svg { width: 32px; height: 32px; color: var(--txt-dim); margin-bottom: 8px; }
  .drop-zone strong { display: block; font-size: 14px; margin-bottom: 4px; }
  .drop-zone span { font-size: 12px; color: var(--txt-dim); }

  /* Progress */
  .progress-container { height: 4px; background: var(--border); border-radius: 2px; overflow: hidden; display: none; }
  .progress-bar { height: 100%; background: var(--acc); width: 0%; transition: width 0.1s; }

  /* Controls */
  .control-block { display: flex; flex-direction: column; gap: 8px; }
  .control-label { font-size: 11px; text-transform: uppercase; color: var(--txt-dim); font-weight: bold; }
  .btn-group { display: flex; gap: 8px; }
  
  button, select {
    background: var(--surf-2); border: 1px solid var(--border); color: var(--txt);
    padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; flex: 1;
    transition: 0.2s;
  }
  button:hover, select:hover { border-color: var(--txt-dim); }
  button:disabled { opacity: 0.5; cursor: not-allowed; }
  button.primary { background: var(--acc); color: #fff; border: none; }
  button.primary:hover { background: var(--acc-hov); }

  /* Tabs */
  .tabs { display: flex; background: var(--surf); border-bottom: 1px solid var(--border); }
  .tab {
    flex: 1; padding: 12px; background: none; border: none; border-bottom: 2px solid transparent;
    color: var(--txt-dim); font-weight: 500; border-radius: 0;
  }
  .tab:hover { color: var(--txt); }
  .tab.active { color: var(--acc); border-bottom-color: var(--acc); }

  /* Gallery Grid */
  #gallery { padding: 15px; overflow-y: auto; flex: 1; }
  .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
  
  .card {
    background: var(--surf); border: 1px solid var(--border); border-radius: 8px;
    overflow: hidden; position: relative; transition: 0.2s;
  }
  .card:hover { transform: translateY(-2px); border-color: var(--txt-dim); }
  .card.selected { border-color: var(--sel); box-shadow: 0 0 0 1px var(--sel); }
  
  .thumb {
    height: 120px; background: #000; display: flex; align-items: center; justify-content: center;
    background-image: radial-gradient(#333 1px, transparent 1px); background-size: 10px 10px;
  }
  .thumb img { max-width: 100%; max-height: 100%; object-fit: contain; }
  
  .meta { padding: 8px; font-size: 11px; color: var(--txt-dim); border-top: 1px solid var(--border); }
  .meta-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
  
  .card-overlay {
    position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; opacity: 0; transition: 0.2s;
  }
  .card:hover .card-overlay { opacity: 1; }
  .icon-btn {
    width: 24px; height: 24px; padding: 0; display: flex; align-items: center; justify-content: center;
    border-radius: 4px; background: rgba(0,0,0,0.7); color: #fff; border: none;
  }
  .icon-btn:hover { background: var(--acc); }

  .select-area {
    padding: 8px; background: var(--surf-2); cursor: pointer; display: flex; align-items: center; gap: 8px;
    font-size: 11px; border-top: 1px solid var(--border);
  }
  .checkbox {
    width: 14px; height: 14px; border: 1px solid var(--txt-dim); border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
  }
  .card.selected .checkbox { background: var(--sel); border-color: var(--sel); }
  .card.selected .checkbox::after { content: "✓"; font-size: 10px; color: #fff; }

  /* Preview */
  #preview { flex: 1; overflow: auto; background: #000; display: none; padding: 20px; text-align: center; }
  .page-container { position: relative; display: inline-block; margin-bottom: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
  .page-canvas { display: block; max-width: 100%; }
  .highlight-box {
    position: absolute; border: 2px solid var(--sel); background: rgba(33,150,243,0.2);
    cursor: pointer; transition: 0.2s;
  }
  .highlight-box:hover { background: rgba(33,150,243,0.4); z-index: 10; }
  .highlight-box.active { border-color: var(--acc); background: rgba(76,175,80,0.3); box-shadow: 0 0 0 2px #fff; z-index: 20; }

  /* Details Pane */
  .details-content { padding: 15px; }
  .detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 12px; }
  .detail-row span:first-child { color: var(--txt-dim); }
  .preview-lg { width: 100%; height: 200px; object-fit: contain; background: #000; border-radius: 6px; margin-bottom: 15px; border: 1px solid var(--border); }
  .ocr-result {
    margin-top: 10px; padding: 10px; background: var(--bg); border: 1px solid var(--border);
    border-radius: 4px; font-family: monospace; font-size: 11px; white-space: pre-wrap; min-height: 50px;
  }

  /* Welcome State */
  #welcome {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    height: 100%; color: var(--txt-dim); cursor: pointer;
  }
  #welcome svg { width: 64px; height: 64px; margin-bottom: 15px; color: var(--border); }
  #welcome:hover svg { color: var(--acc); }

  .hidden { display: none !important; }
</style>
</head>
<body>

<header>
  <h1>PDF Image Extractor <span style="color:var(--acc); font-size:12px; margin-left:5px">Ultimate</span></h1>
  <div id="status">Idle</div>
</header>

<aside id="left">
  <!-- Upload -->
  <div class="drop-zone" id="dropZone">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
      <polyline points="17 8 12 3 7 8"></polyline>
      <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
    <strong>Click or Drop PDF</strong>
    <span>Fast & Secure (Local)</span>
  </div>
  <input type="file" id="fileInput" accept="application/pdf" hidden>
  
  <div class="progress-container" id="progressWrap">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <!-- Filters -->
  <div class="control-block">
    <div class="control-label">Filter & Sort</div>
    <div class="btn-group">
      <select id="filterType">
        <option value="all">All Assets</option>
        <option value="image">Images Only</option>
        <option value="small">Icons/Small</option>
      </select>
    </div>
    <div class="btn-group">
      <select id="sortType">
        <option value="page">By Page</option>
        <option value="size">By Size (Area)</option>
      </select>
    </div>
  </div>

  <!-- Actions -->
  <div class="control-block">
    <div class="control-label">Selection</div>
    <div class="btn-group">
      <button id="btnSelAll">All</button>
      <button id="btnSelNone">None</button>
    </div>
    <button id="btnDlZip" class="primary" disabled>Download ZIP</button>
    <button id="btnDlSep" disabled>Download Separate</button>
  </div>
</aside>

<main id="main">
  <div class="tabs">
    <button class="tab active" data-target="gallery">Gallery (<span id="count">0</span>)</button>
    <button class="tab" data-target="preview">Interactive Preview</button>
  </div>

  <div id="gallery">
    <div id="welcome">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>
      <p>Click here or drag a PDF to start</p>
    </div>
    <div class="grid" id="grid"></div>
  </div>

  <div id="preview"></div>
</main>

<aside id="right">
  <div class="tabs" style="justify-content: center; padding: 12px; font-size: 12px; color: var(--txt-dim); border-bottom: 1px solid var(--border);">
    DETAILS
  </div>
  <div class="details-content" id="details">
    <div style="text-align:center; color: var(--txt-dim); margin-top: 20px;">
      Select an image to view details.
    </div>
  </div>
</aside>

<script>
(() => {
  // --- State ---
  const state = {
    pdf: null,
    assets: [], // { id, page, width, height, blob, url, x, y, w, h }
    pages: [],  // { w, h, viewport }
    selected: new Set(),
    abortCtrl: null
  };

  const ui = {
    drop: document.getElementById('dropZone'),
    welcome: document.getElementById('welcome'),
    file: document.getElementById('fileInput'),
    bar: document.getElementById('progressBar'),
    barWrap: document.getElementById('progressWrap'),
    status: document.getElementById('status'),
    grid: document.getElementById('grid'),
    preview: document.getElementById('preview'),
    details: document.getElementById('details'),
    count: document.getElementById('count'),
    tabs: document.querySelectorAll('.tab'),
    // Controls
    filter: document.getElementById('filterType'),
    sort: document.getElementById('sortType'),
    selAll: document.getElementById('btnSelAll'),
    selNone: document.getElementById('btnSelNone'),
    dlZip: document.getElementById('btnDlZip'),
    dlSep: document.getElementById('btnDlSep'),
  };

  // --- Event Listeners ---
  
  // Drag & Drop / File Input
  const openFile = () => ui.file.click();
  ui.drop.addEventListener('click', openFile);
  ui.welcome.addEventListener('click', openFile);
  ui.file.addEventListener('change', e => loadPDF(e.target.files[0]));
  
  ['dragenter', 'dragover'].forEach(e => {
    ui.drop.addEventListener(e, ev => { ev.preventDefault(); ui.drop.classList.add('drag'); });
    document.body.addEventListener(e, ev => ev.preventDefault()); // Prevent browser open
  });
  ['dragleave', 'drop'].forEach(e => {
    ui.drop.addEventListener(e, ev => { ev.preventDefault(); ui.drop.classList.remove('drag'); });
  });
  ui.drop.addEventListener('drop', e => loadPDF(e.dataTransfer.files[0]));
  document.body.addEventListener('drop', e => { e.preventDefault(); if(e.target === ui.welcome) loadPDF(e.dataTransfer.files[0]); });

  // Tabs
  ui.tabs.forEach(t => t.addEventListener('click', () => {
    ui.tabs.forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    const target = t.dataset.target;
    document.getElementById('gallery').style.display = target === 'gallery' ? 'block' : 'none';
    document.getElementById('preview').style.display = target === 'preview' ? 'block' : 'none';
    if (target === 'preview') renderPreview();
  }));

  // Controls
  ui.filter.addEventListener('change', renderGrid);
  ui.sort.addEventListener('change', renderGrid);
  ui.selAll.addEventListener('click', () => { state.assets.forEach(a => state.selected.add(a.id)); updateSelection(); });
  ui.selNone.addEventListener('click', () => { state.selected.clear(); updateSelection(); });
  ui.dlZip.addEventListener('click', () => downloadBatch(true));
  ui.dlSep.addEventListener('click', () => downloadBatch(false));

  // --- Core Logic ---

  async function loadPDF(file) {
    if (!file || file.type !== 'application/pdf') return alert('Please select a PDF file.');

    // Reset UI
    if (state.abortCtrl) state.abortCtrl.abort();
    state.abortCtrl = new AbortController();
    state.assets.forEach(a => URL.revokeObjectURL(a.url));
    state.assets = [];
    state.pages = [];
    state.selected.clear();
    ui.grid.innerHTML = '';
    ui.preview.innerHTML = '';
    ui.welcome.style.display = 'none';
    ui.barWrap.style.display = 'block';
    ui.bar.style.width = '0%';
    updateSelection();

    try {
      ui.status.textContent = 'Reading file...';
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument(buf).promise;
      state.pdf = pdf;

      ui.status.textContent = `Scanning ${pdf.numPages} pages...`;
      
      for (let i = 1; i <= pdf.numPages; i++) {
        if (state.abortCtrl.signal.aborted) return;
        ui.bar.style.width = `${(i / pdf.numPages) * 100}%`;
        await extractPage(i);
      }

      ui.status.textContent = `Done. Found ${state.assets.length} images.`;
      ui.barWrap.style.display = 'none';
      renderGrid();

    } catch (e) {
      console.error(e);
      ui.status.textContent = 'Error: ' + e.message;
    }
  }

  async function extractPage(pageNum) {
    const page = await state.pdf.getPage(pageNum);
    const viewport = page.getViewport({ scale: 1.5 }); // Good scale for preview
    state.pages[pageNum] = { w: viewport.width, h: viewport.height, viewport, pageObj: page };

    // 1. Setup Interception
    // We create a dummy canvas context to intercept drawImage calls.
    // This ensures we get the SOURCE image (full res) not the drawn result.
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Store original drawImage
    const origDrawImage = ctx.drawImage;
    
    let imgCount = 0;

    ctx.drawImage = function(...args) {
      // args[0] is the source image (Image, Canvas, or ImageBitmap)
      const img = args[0];
      if (!img || !img.width || !img.height) return;

      // Filter out tiny things (likely text artifacts or lines)
      if (img.width < 20 || img.height < 20) return;

      // Capture coordinates for Preview
      // drawImage(img, dx, dy)
      // drawImage(img, dx, dy, dw, dh)
      // drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh)
      let dx=0, dy=0, dw=img.width, dh=img.height;

      if (args.length === 3) { dx=args[1]; dy=args[2]; }
      else if (args.length === 5) { dx=args[1]; dy=args[2]; dw=args[3]; dh=args[4]; }
      else if (args.length === 9) { dx=args[5]; dy=args[6]; dw=args[7]; dh=args[8]; }

      // Process the image
      processAsset(img, pageNum, ++imgCount, {x:dx, y:dy, w:dw, h:dh});
    };

    // 2. Render the page to the dummy context
    // This triggers our intercepted drawImage for every image on the page
    await page.render({ canvasContext: ctx, viewport }).promise;
    
    // Restore (not strictly necessary as we discard ctx, but good practice)
    ctx.drawImage = origDrawImage;
  }

  async function processAsset(source, pageNum, seq, coords) {
    // Create a temporary canvas to extract the image data as PNG
    const c = document.createElement('canvas');
    c.width = source.width;
    c.height = source.height;
    const cx = c.getContext('2d');
    cx.drawImage(source, 0, 0);

    c.toBlob(blob => {
      if (!blob) return;
      const url = URL.createObjectURL(blob);
      const id = `p${pageNum}-${seq}`;
      
      state.assets.push({
        id,
        page: pageNum,
        width: source.width,
        height: source.height,
        area: source.width * source.height,
        blob,
        url,
        coords // {x, y, w, h} in Viewport pixels
      });
      
      // Update count live
      ui.count.textContent = state.assets.length;
    }, 'image/png');
  }

  // --- Rendering ---

  function renderGrid() {
    const filter = ui.filter.value;
    const sort = ui.sort.value;
    
    let list = [...state.assets];

    // Filter
    if (filter === 'image') list = list.filter(a => a.width > 100 && a.height > 100);
    if (filter === 'small') list = list.filter(a => a.width <= 100 || a.height <= 100);

    // Sort
    if (sort === 'size') list.sort((a,b) => b.area - a.area);
    else list.sort((a,b) => a.page - b.page || a.id.localeCompare(b.id));

    ui.grid.innerHTML = '';
    
    list.forEach(asset => {
      const el = document.createElement('div');
      el.className = `card ${state.selected.has(asset.id) ? 'selected' : ''}`;
      el.onclick = (e) => {
        if(e.target.closest('.icon-btn') || e.target.closest('.select-area')) return;
        showDetails(asset);
      };

      el.innerHTML = `
        <div class="card-overlay">
          <button class="icon-btn" onclick="downloadOne('${asset.id}')" title="Download">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
          </button>
        </div>
        <div class="thumb"><img src="${asset.url}" loading="lazy"></div>
        <div class="meta">
          <div class="meta-row">
            <span style="color:#fff">${asset.width}×${asset.height}</span>
            <span>P.${asset.page}</span>
          </div>
          <div class="meta-row">
            <span>${(asset.blob.size/1024).toFixed(0)} KB</span>
            <span>PNG</span>
          </div>
        </div>
        <div class="select-area" onclick="toggleSel('${asset.id}', this)">
          <div class="checkbox"></div>
          <span>Select</span>
        </div>
      `;
      ui.grid.appendChild(el);
    });
    updateSelection();
  }

  window.toggleSel = (id, el) => {
    if (state.selected.has(id)) state.selected.delete(id);
    else state.selected.add(id);
    el.closest('.card').classList.toggle('selected', state.selected.has(id));
    updateSelection();
  };

  function updateSelection() {
    const n = state.selected.size;
    ui.dlZip.disabled = n === 0;
    ui.dlSep.disabled = n === 0;
    ui.dlZip.textContent = n ? `Download ZIP (${n})` : 'Download ZIP';
    ui.dlSep.textContent = n ? `Download Separate (${n})` : 'Download Separate';
  }

  // --- Details & OCR ---

  async function showDetails(asset) {
    ui.details.innerHTML = `
      <img src="${asset.url}" class="preview-lg">
      <div class="detail-row"><span>ID</span> <span>${asset.id}</span></div>
      <div class="detail-row"><span>Page</span> <span>${asset.page}</span></div>
      <div class="detail-row"><span>Dimensions</span> <span>${asset.width} × ${asset.height}</span></div>
      <div class="detail-row"><span>File Size</span> <span>${(asset.blob.size/1024).toFixed(2)} KB</span></div>
      <div style="margin-top:15px; display:flex; gap:10px">
        <button class="primary" onclick="downloadOne('${asset.id}')">Download</button>
        <button onclick="doOCR('${asset.id}')">OCR Text</button>
      </div>
      <div id="ocr-${asset.id}" class="ocr-result hidden"></div>
    `;
    
    // Highlight in preview if visible
    if (document.getElementById('preview').style.display === 'block') {
      renderPreview(asset.id);
    }
  }

  window.doOCR = async (id) => {
    const asset = state.assets.find(a => a.id === id);
    const box = document.getElementById(`ocr-${id}`);
    if(!asset || !box) return;
    
    box.classList.remove('hidden');
    box.textContent = 'Scanning...';
    try {
      const { data } = await Tesseract.recognize(asset.blob, 'eng');
      box.textContent = data.text.trim() || 'No text found.';
    } catch(e) {
      box.textContent = 'Error: ' + e.message;
    }
  };

  // --- Interactive Preview ---
  
  let previewBuilt = false;

  async function renderPreview(highlightId = null) {
    // Only build DOM once to save performance
    if (!previewBuilt) {
      ui.preview.innerHTML = '';
      const pages = [...new Set(state.assets.map(a => a.page))].sort((a,b)=>a-b);
      
      for (const pNum of pages) {
        const pInfo = state.pages[pNum];
        if (!pInfo) continue;

        const wrap = document.createElement('div');
        wrap.className = 'page-container';
        
        // Render background canvas
        const canvas = document.createElement('canvas');
        canvas.className = 'page-canvas';
        canvas.width = pInfo.w;
        canvas.height = pInfo.h;
        wrap.appendChild(canvas);
        
        // Async render
        pInfo.pageObj.render({ canvasContext: canvas.getContext('2d'), viewport: pInfo.viewport });

        // Overlay Boxes
        const pageAssets = state.assets.filter(a => a.page === pNum);
        pageAssets.forEach(asset => {
          const box = document.createElement('div');
          box.className = 'highlight-box';
          box.id = `box-${asset.id}`;
          
          // The coords captured in extractPage are already in Viewport pixels
          // because we passed the viewport to page.render
          const { x, y, w, h } = asset.coords;
          
          box.style.left = `${x}px`;
          box.style.top = `${y}px`;
          box.style.width = `${w}px`;
          box.style.height = `${h}px`;
          
          box.title = `${asset.width}x${asset.height}`;
          box.onclick = (e) => { e.stopPropagation(); showDetails(asset); };
          
          wrap.appendChild(box);
        });

        ui.preview.appendChild(wrap);
      }
      previewBuilt = true;
    }

    // Handle Highlighting
    document.querySelectorAll('.highlight-box').forEach(b => b.classList.remove('active'));
    if (highlightId) {
      const el = document.getElementById(`box-${highlightId}`);
      if (el) {
        el.classList.add('active');
        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  }

  // --- Download Logic ---

  window.downloadOne = (id) => {
    const a = state.assets.find(x => x.id === id);
    if(a) save(a.blob, `img-${a.id}.png`);
  };

  async function downloadBatch(zipMode) {
    const items = state.assets.filter(a => state.selected.has(a.id));
    if (!items.length) return;

    if (zipMode) {
      ui.status.textContent = 'Zipping...';
      const zip = new JSZip();
      items.forEach(a => zip.file(`img-${a.id}.png`, a.blob));
      const content = await zip.generateAsync({type:'blob'});
      save(content, 'images.zip');
      ui.status.textContent = 'Done';
    } else {
      ui.status.textContent = 'Downloading...';
      for (const a of items) {
        save(a.blob, `img-${a.id}.png`);
        await new Promise(r => setTimeout(r, 300)); // Delay to prevent blocking
      }
      ui.status.textContent = 'Done';
    }
  }

  function save(blob, name) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

})();
</script>
</body>
</html>
